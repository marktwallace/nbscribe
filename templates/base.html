<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ title or "nbscribe" }}</title>
    <!-- htmx + SSE ext -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="https://unpkg.com/htmx.org@1.9.12/dist/ext/sse.js"></script>
    <!-- CodeMirror 5 (simple for M0) -->
    <link rel="stylesheet" href="https://unpkg.com/codemirror@5/lib/codemirror.css" />
    <script src="https://unpkg.com/codemirror@5/lib/codemirror.js"></script>
    <script src="https://unpkg.com/codemirror@5/mode/python/python.js"></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1rem; }
      .cell { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; margin: 0.75rem 0; }
      .toolbar { display: flex; gap: 0.5rem; margin: 0.5rem 0; }
      .toolbar button { padding: 0.35rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; background: #f9fafb; cursor: pointer; }
      .stream.stdout { color: #111827; white-space: pre-wrap; }
      .stream.stderr { color: #991b1b; white-space: pre-wrap; }
      .error { color: #b91c1c; white-space: pre-wrap; }
      .cm-editor, .CodeMirror { border: 1px solid #e5e7eb; border-radius: 0.375rem; }
    </style>
  </head>
  <body>
    {% block content %}{% endblock %}

    <script>
      function initEditors(scope=document){
        scope.querySelectorAll('textarea.code').forEach(t=>{
          if (t._cm) return;
          t._cm = CodeMirror.fromTextArea(t, { lineNumbers: true, mode: t.dataset.lang||'python' });
          // Ctrl/Cmd+Enter runs the nearest cell
          t._cm.addKeyMap({
            'Cmd-Enter': ()=>runNearest(t),
            'Ctrl-Enter': ()=>runNearest(t),
          });
        });
      }
      function runNearest(textarea){
        const cell = textarea.closest('.cell');
        const runBtn = cell && cell.querySelector('[data-run]');
        if (runBtn) runBtn.click();
      }
      document.addEventListener('DOMContentLoaded', ()=> initEditors());
      document.body.addEventListener('htmx:afterSwap', (e)=> initEditors(e.target));
    </script>
  </body>
  </html>


