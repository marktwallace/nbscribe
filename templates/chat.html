<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title | default("nbscribe - Conversation Log") }}</title>
    <meta name="generator" content="nbscribe {{ version | default('0.1.0') }}">
    <meta name="conversation-id" content="{{ conversation_id | default('default') }}">
    <meta name="created" content="{{ created_at | default('') }}">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 2rem; 
            background-color: #f8f9fa;
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #333; 
            margin-bottom: 0.5rem;
        }
        .subtitle {
            color: #666;
            margin-bottom: 2rem;
        }
        .conversation-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }
        .conversation-meta {
            font-size: 0.9em;
            color: #666;
            margin-top: 0.5rem;
        }
        .conversation-meta span {
            margin-right: 1rem;
        }
        .chat-container {
            margin: 2rem 0;
        }
        .chat-history {
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 300px;
            padding: 1rem;
            overflow-y: auto;
            background: #fafafa;
            margin-bottom: 1rem;
        }
        
        /* Chat message semantics */
        chat-msg {
            display: block;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 4px;
            white-space: pre-wrap;
            position: relative;
        }
        
        chat-msg[role="user"] {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin-left: 2rem;
        }
        
        chat-msg[role="assistant"] {
            background: #f1f8e9;
            border-left: 4px solid #4caf50;
            margin-right: 2rem;
        }
        
        chat-msg[role="system"] {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            font-style: italic;
        }
        
        /* Role labels */
        chat-msg::before {
            content: attr(role);
            display: block;
            font-weight: bold;
            font-size: 0.8em;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            opacity: 0.7;
        }
        
        chat-msg[role="user"]::before {
            content: "You";
            color: #1976d2;
        }
        
        chat-msg[role="assistant"]::before {
            content: "nbscribe";
            color: #388e3c;
        }
        
        chat-msg[role="system"]::before {
            content: "System";
            color: #f57c00;
        }
        .chat-form {
            display: flex;
            gap: 0.5rem;
        }
        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .chat-submit {
            padding: 0.75rem 1.5rem;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .chat-submit:hover {
            background: #0056b3;
        }
        .chat-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .error {
            padding: 1rem;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            color: #721c24;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="conversation-header">
            <h1>{{ service_name | default("nbscribe") }} - Conversation Log</h1>
            <div class="conversation-meta">
                <span>Session: {{ conversation_id | default("default") }}</span>
                <span>Started: {{ created_at | default("") }}</span>
                <span>Version: {{ version | default("0.1.0") }}</span>
            </div>
        </header>
        
        <div class="chat-container">
            <h3>Chat with nbscribe</h3>
            <div id="chat-history" class="chat-history">
                {% if messages %}
                    {% for message in messages %}
                    <chat-msg role="{{ message.role }}" timestamp="{{ message.timestamp }}">{{ message.content }}</chat-msg>
                    {% endfor %}
                {% else %}
                    <chat-msg role="assistant" timestamp="{{ created_at }}">Hello! I'm your AI Jupyter assistant. Type a message below to get started.</chat-msg>
                {% endif %}
            </div>
            
            <form id="chat-form" class="chat-form">
                <input 
                    type="text" 
                    id="chat-input" 
                    class="chat-input" 
                    placeholder="Type your message here..."
                    required
                    autocomplete="off"
                >
                <button type="submit" id="chat-submit" class="chat-submit">Send</button>
            </form>
            
            <div id="error-message" class="error" style="display: none;"></div>
        </div>
    </div>

    <script>
        class ChatInterface {
            constructor() {
                this.chatForm = document.getElementById('chat-form');
                this.chatInput = document.getElementById('chat-input');
                this.chatSubmit = document.getElementById('chat-submit');
                this.chatHistory = document.getElementById('chat-history');
                this.errorMessage = document.getElementById('error-message');
                
                // Extract session ID from page metadata
                this.sessionId = document.querySelector('meta[name="conversation-id"]').getAttribute('content');
                
                this.initEventListeners();
                this.scrollToBottom(); // Scroll to bottom on page load
            }
            
            initEventListeners() {
                this.chatForm.addEventListener('submit', (e) => this.handleSubmit(e));
                
                // Allow Enter key to submit (but Shift+Enter for new line)
                this.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.chatForm.dispatchEvent(new Event('submit'));
                    }
                });
            }
            
            async handleSubmit(e) {
                e.preventDefault();
                
                const message = this.chatInput.value.trim();
                if (!message) return;
                
                // Add user message to chat
                this.addMessage('user', message);
                
                // Clear input and disable form
                this.chatInput.value = '';
                this.setLoading(true);
                this.hideError();
                
                try {
                    // Try streaming first, fallback to regular if it fails
                    const success = await this.tryStreamingResponse(message);
                    if (!success) {
                        // Fallback to regular response
                        const response = await this.sendMessage(message);
                        this.addMessage('assistant', response.response);
                    }
                } catch (error) {
                    this.showError(`Error: ${error.message}`);
                    console.error('Chat error:', error);
                } finally {
                    this.setLoading(false);
                    this.chatInput.focus();
                }
            }
            
            async tryStreamingResponse(message) {
                // Try to get a streaming response, return true if successful
                try {
                    const response = await fetch('/api/chat/stream', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            message: message,
                            session_id: this.sessionId
                        })
                    });
                    
                    if (!response.ok) {
                        console.warn('Streaming failed, will use fallback');
                        return false;
                    }
                    
                    // Create assistant message element for streaming
                    const messageEl = document.createElement('chat-msg');
                    messageEl.setAttribute('role', 'assistant');
                    messageEl.setAttribute('timestamp', new Date().toISOString());
                    messageEl.textContent = '';
                    this.chatHistory.appendChild(messageEl);
                    this.scrollToBottom();
                    
                    // Process the stream
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line in buffer
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    if (data.type === 'chunk') {
                                        // Append chunk to message
                                        messageEl.textContent += data.content;
                                        this.scrollToBottom();
                                    } else if (data.type === 'complete') {
                                        // Streaming complete - file already saved on server
                                        return true;
                                    } else if (data.type === 'error') {
                                        // Remove partial message and let fallback handle it
                                        messageEl.remove();
                                        throw new Error(data.content);
                                    }
                                } catch (parseError) {
                                    console.warn('Failed to parse SSE data:', parseError);
                                }
                            }
                        }
                    }
                    
                    return true;
                    
                } catch (error) {
                    console.warn('Streaming failed:', error);
                    return false;
                }
            }
            
            async sendMessage(message) {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        session_id: this.sessionId  // Include session ID in API call
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error occurred');
                }
                
                return data;
            }
            
            addMessage(role, content) {
                const messageEl = document.createElement('chat-msg');
                messageEl.setAttribute('role', role);
                messageEl.setAttribute('timestamp', new Date().toISOString());
                messageEl.textContent = content;
                
                this.chatHistory.appendChild(messageEl);
                this.scrollToBottom();
            }
            
            setLoading(loading) {
                this.chatSubmit.disabled = loading;
                this.chatInput.disabled = loading;
                this.chatSubmit.textContent = loading ? 'Sending...' : 'Send';
            }
            
            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
            }
            
            hideError() {
                this.errorMessage.style.display = 'none';
            }
            
            scrollToBottom() {
                this.chatHistory.scrollTop = this.chatHistory.scrollHeight;
            }
        }
        
        // Initialize chat interface when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ChatInterface();
        });
    </script>
</body>
</html> 