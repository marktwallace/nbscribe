<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title | default("nbscribe - Conversation Log") }}</title>
    <meta name="generator" content="nbscribe {{ version | default('0.1.0') }}">
    <meta name="conversation-id" content="{{ conversation_id | default('default') }}">
    <meta name="created" content="{{ created_at | default('') }}">
    
    <!-- Markdown rendering support -->
    <link rel="stylesheet" href="/static/conversation.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/5.1.1/marked.min.js"></script>
    
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #ffffff;
        }
        
        /* Header - scrolls with content */
        .header {
            padding: 1rem 4%;
            border-bottom: 1px solid #e5e5e5;
            background: #f8f9fa;
        }
        
        .header h1 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .session-info {
            font-size: 0.85rem;
            color: #666;
        }
        
        .session-info span {
            margin-right: 1.5rem;
        }
        
        /* Main conversation area */
        .conversation {
            padding: 2rem 4%;
            min-height: calc(100vh - 200px);
        }
        
        /* ChatGPT-style message layout */
        chat-msg {
            display: block;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        /* User messages: indented, contained width */
        chat-msg[role="user"] {
            max-width: 70%;
            margin-left: auto;
            margin-right: 0;
            padding: 1rem 1.5rem;
            background: #f7f7f8;
            border-radius: 18px;
            border-bottom-right-radius: 4px;
        }
        
        /* Assistant messages: full width, subtle background */
        chat-msg[role="assistant"] {
            width: 100%;
            padding: 1.5rem 0;
            background: #ffffff;
            margin-left: -4%;
            margin-right: -4%;
            padding-left: 4%;
            padding-right: 4%;
        }
        
        /* System messages: centered, minimal */
        chat-msg[role="system"] {
            max-width: 60%;
            margin: 1rem auto;
            padding: 0.75rem 1rem;
            background: #fff3cd;
            border-radius: 8px;
            font-style: italic;
            text-align: center;
            font-size: 0.9rem;
        }
        
        /* Remove role labels - visual distinction is enough */
        chat-msg::before {
            display: none;
        }
        
        /* Input area - at document bottom */
        .input-area {
            position: relative;
            padding: 1.5rem 4%;
            border-top: 1px solid #e5e5e5;
            background: #ffffff;
        }
        
        .chat-form {
            display: flex;
            gap: 0.75rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            background: #ffffff;
            resize: none;
            min-height: 66px; /* Start with ~3 lines */
            max-height: 120px;
            overflow-y: hidden; /* Remove scrollbar */
            line-height: 1.4;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 1px #2563eb;
        }
        
        .chat-submit {
            padding: 0.75rem 1.5rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .chat-submit:hover {
            background: #1d4ed8;
        }
        
        .chat-submit:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        /* Loading indicator */
        .loading-dots {
            display: none;
            text-align: left;
            padding: 1.5rem 0;
            background: #ffffff;
            margin-left: -4%;
            margin-right: -4%;
            padding-left: 4%;
            padding-right: 4%;
        }
        
        .loading-dots::after {
            content: "●";
            animation: dots 1.5s infinite;
            color: #666;
            font-size: 1.2rem;
        }
        
        @keyframes dots {
            0%, 20% { content: "●"; }
            40% { content: "● ●"; }
            60% { content: "● ● ●"; }
            80%, 100% { content: "●"; }
        }
        
        /* Error messages */
        .error {
            padding: 1rem;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #dc2626;
            margin: 1rem 0;
            display: none;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .conversation,
            .header,
            .input-area {
                padding-left: 3%;
                padding-right: 3%;
            }
            
            chat-msg[role="assistant"] {
                margin-left: -3%;
                margin-right: -3%;
                padding-left: 3%;
                padding-right: 3%;
            }
            
            .loading-dots {
                margin-left: -3%;
                margin-right: -3%;
                padding-left: 3%;
                padding-right: 3%;
            }
            
            chat-msg[role="user"] {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>{{ service_name | default("nbscribe") }}</h1>
        <div class="session-info">
            <span>Session {{ conversation_id | default("default") }}</span>
            <span>{{ created_at | default("") }}</span>
        </div>
    </header>
    
    <main class="conversation" id="conversation">
        {% if messages %}
            {% for message in messages %}
            <chat-msg role="{{ message.role }}" timestamp="{{ message.timestamp }}">{{ message.content }}</chat-msg>
            {% endfor %}
        {% else %}
            <chat-msg role="assistant" timestamp="{{ created_at }}">Hello! I'm your AI Jupyter assistant. Type a message below to get started.</chat-msg>
        {% endif %}
        
        <div id="loading-indicator" class="loading-dots"></div>
    </main>
    
    <div class="input-area">
        <form id="chat-form" class="chat-form">
            <textarea 
                id="chat-input" 
                class="chat-input" 
                placeholder="Type your message here..."
                required
                rows="1"
            ></textarea>
            <button type="submit" id="chat-submit" class="chat-submit">Send</button>
        </form>
        
        <div id="error-message" class="error"></div>
    </div>

    <script>
        class ChatInterface {
            constructor() {
                this.chatForm = document.getElementById('chat-form');
                this.chatInput = document.getElementById('chat-input');
                this.chatSubmit = document.getElementById('chat-submit');
                this.chatHistory = document.getElementById('conversation');
                this.loadingIndicator = document.getElementById('loading-indicator');
                this.errorMessage = document.getElementById('error-message');
                
                // Extract session ID from page metadata
                this.sessionId = document.querySelector('meta[name="conversation-id"]').getAttribute('content');
                
                this.initMarkdown();
                this.initEventListeners();
                this.renderExistingMarkdown(); // Render any existing messages
                this.scrollToBottom(); // Scroll to bottom on page load
            }
            
            initMarkdown() {
                // Configure marked for consistent rendering - more like ChatGPT
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        breaks: true,
                        gfm: true,
                        headerIds: false,
                        mangle: false,
                        pedantic: false,  // Don't be overly strict about markdown
                        smartypants: false // Prevent smart quote conversion
                    });
                    
                    // Custom renderer to handle lists more like ChatGPT
                    const renderer = new marked.Renderer();
                    
                    // Override list item rendering to reduce paragraph wrapping
                    renderer.listitem = function(text) {
                        // If the text is simple (no nested blocks), don't wrap in <p>
                        if (!text.includes('<p>') && !text.includes('<blockquote>') && !text.includes('<pre>')) {
                            return `<li>${text.trim()}</li>\n`;
                        }
                        return `<li>${text}</li>\n`;
                    };
                    
                    marked.setOptions({ renderer: renderer });
                }
            }
            
            renderExistingMarkdown() {
                // Render markdown in any existing assistant messages
                const assistantMessages = this.chatHistory.querySelectorAll('chat-msg[role="assistant"]');
                assistantMessages.forEach(msg => this.renderMessageMarkdown(msg));
            }
            
            renderMessageMarkdown(messageElement) {
                // Only render markdown for assistant messages
                if (messageElement.getAttribute('role') !== 'assistant') return;
                
                const rawContent = messageElement.textContent;
                if (typeof marked !== 'undefined' && rawContent.trim()) {
                    try {
                        const renderedHtml = marked.parse(rawContent);
                        messageElement.innerHTML = `<div class="markdown-body">${renderedHtml}</div>`;
                    } catch (error) {
                        console.warn('Markdown rendering failed:', error);
                        // Keep original text content if rendering fails
                    }
                }
            }
            
            initEventListeners() {
                this.chatForm.addEventListener('submit', (e) => this.handleSubmit(e));
                
                // Auto-resize textarea
                this.chatInput.addEventListener('input', () => this.autoResize());
                
                // Remove Enter key submission - button only now
                // Users can use Enter for new lines without accidentally sending
            }
            
            autoResize() {
                this.chatInput.style.height = 'auto';
                this.chatInput.style.height = Math.max(this.chatInput.scrollHeight, 66) + 'px';
            }
            
            async handleSubmit(e) {
                e.preventDefault();
                
                const message = this.chatInput.value.trim();
                if (!message) return;
                
                // Add user message to chat
                this.addMessage('user', message);
                
                // Clear input and disable form
                this.chatInput.value = '';
                this.autoResize();
                this.setFormDisabled(true);
                this.showLoadingDots(); // Show dots for initial latency
                this.hideError();
                
                try {
                    // Try streaming first, fallback to regular if it fails
                    const success = await this.tryStreamingResponse(message);
                    if (!success) {
                        // Fallback to regular response
                        this.hideLoadingDots(); // Hide dots before showing fallback response
                        const response = await this.sendMessage(message);
                        this.addMessage('assistant', response.response);
                    }
                } catch (error) {
                    this.showError(`Error: ${error.message}`);
                    console.error('Chat error:', error);
                } finally {
                    this.setFormDisabled(false);
                    this.hideLoadingDots();
                    this.chatInput.focus();
                }
            }
            
            async tryStreamingResponse(message) {
                // Try to get a streaming response, return true if successful
                try {
                    const response = await fetch('/api/chat/stream', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            message: message,
                            session_id: this.sessionId
                        })
                    });
                    
                    if (!response.ok) {
                        console.warn('Streaming failed, will use fallback');
                        return false;
                    }
                    
                    // Hide loading dots once streaming starts
                    this.hideLoadingDots();
                    
                    // Create assistant message element for streaming
                    const messageEl = document.createElement('chat-msg');
                    messageEl.setAttribute('role', 'assistant');
                    messageEl.setAttribute('timestamp', new Date().toISOString());
                    messageEl.textContent = '';
                    
                    // Insert before loading indicator
                    this.chatHistory.insertBefore(messageEl, this.loadingIndicator);
                    this.scrollToBottom();
                    
                    // Process the stream
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line in buffer
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    if (data.type === 'chunk') {
                                        // Append chunk to message
                                        messageEl.textContent += data.content;
                                        this.scrollToBottom();
                                    } else if (data.type === 'complete') {
                                        // Streaming complete - render markdown and file already saved on server
                                        this.renderMessageMarkdown(messageEl);
                                        return true;
                                    } else if (data.type === 'error') {
                                        // Remove partial message and let fallback handle it
                                        messageEl.remove();
                                        throw new Error(data.content);
                                    }
                                } catch (parseError) {
                                    console.warn('Failed to parse SSE data:', parseError);
                                }
                            }
                        }
                    }
                    
                    return true;
                    
                } catch (error) {
                    console.warn('Streaming failed:', error);
                    return false;
                }
            }
            
            async sendMessage(message) {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        session_id: this.sessionId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Unknown error occurred');
                }
                
                return data;
            }
            
            addMessage(role, content) {
                const messageEl = document.createElement('chat-msg');
                messageEl.setAttribute('role', role);
                messageEl.setAttribute('timestamp', new Date().toISOString());
                messageEl.textContent = content;
                
                // Insert before loading indicator
                this.chatHistory.insertBefore(messageEl, this.loadingIndicator);
                
                // Render markdown for assistant messages
                if (role === 'assistant') {
                    this.renderMessageMarkdown(messageEl);
                }
                
                this.scrollToBottom();
            }
            
            setFormDisabled(disabled) {
                this.chatSubmit.disabled = disabled;
                this.chatInput.disabled = disabled;
                this.chatSubmit.textContent = disabled ? 'Sending...' : 'Send';
            }
            
            showLoadingDots() {
                this.loadingIndicator.style.display = 'block';
                this.scrollToBottom();
            }
            
            hideLoadingDots() {
                this.loadingIndicator.style.display = 'none';
            }
            
            // Legacy method for backward compatibility
            setLoading(loading) {
                this.setFormDisabled(loading);
                if (loading) {
                    this.showLoadingDots();
                } else {
                    this.hideLoadingDots();
                }
            }
            
            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
                this.scrollToBottom();
            }
            
            hideError() {
                this.errorMessage.style.display = 'none';
            }
            
            scrollToBottom() {
                // Use smooth scrolling to bottom of document
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }
        
        // Initialize chat interface when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ChatInterface();
        });
    </script>
</body>
</html> 